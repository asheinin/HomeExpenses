<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #764ba2;
      --text: #333;
      --text-light: #666;
      --bg: #f8f9fa;
      --card-bg: #fff;
      --error: #d93025;
      --success: #2e7d32;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      margin: 0;
      padding: 20px;
      color: var(--text);
      background: var(--bg);
    }

    .form-container {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-light);
      display: block;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-row {
      display: flex;
      gap: 15px;
      background: #f1f3f9;
      padding: 12px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      color: var(--text);
    }

    .checkbox-inline input {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    button {
      flex: 1;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      font-family: inherit;
    }

    button:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(118, 75, 162, 0.2);
    }

    .btn-secondary {
      background: #f1f3f4;
      color: var(--text);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error-box {
      background: #fce8e6;
      color: var(--error);
      padding: 10px 14px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      display: none;
      border: 1px solid #f5c2c7;
    }

    .input-error {
      border-color: var(--error) !important;
      background: #fff8f8;
    }

    .required-star {
      color: var(--error);
    }
  </style>

</head>

<body>
  <div class="form-container">
    <h2>ðŸ’¸ Add New Expense</h2>

    <div id="errorMessage" class="error-box"></div>

    <form id="expenseForm">
      <div class="form-group">
        <label for="expenseName">Expense Name <span class="required-star">*</span></label>
        <input type="text" id="expenseName" placeholder="e.g. Home Insurance" required>
      </div>

      <div class="form-group">
        <label for="expenseType">Category <span class="required-star">*</span></label>
        <input type="text" id="expenseType" list="typeChoices" placeholder="e.g. Utilities" required>
        <datalist id="typeChoices">
          <? for (var i = 0; i < expenseTypes.length; i++) { ?>
          <option value="<?= expenseTypes[i] ?>">
            <? } ?>
        </datalist>
      </div>

      <div class="form-group">
        <label for="expenseAmount">Amount ($)</label>
        <input type="number" step="0.01" id="expenseAmount" placeholder="0.00">
      </div>

      <div class="checkbox-row">
        <label class="checkbox-inline">
          <input type="checkbox" id="papCheckbox"> PAP
        </label>
        <label class="checkbox-inline">
          <input type="checkbox" id="splitCheckbox" checked> Split
        </label>
        <label class="checkbox-inline">
          <input type="checkbox" id="paidCheckbox"> Paid
        </label>
      </div>

      <div class="form-group">
        <label for="expensePeriod">Billing Period</label>
        <select id="expensePeriod">
          <option value="">Select Period</option>
          <? for (var i = 0; i < expensePeriods.length; i++) { ?>
          <option value="<?= expensePeriods[i] ?>">
            <?= expensePeriods[i] ?>
          </option>
          <? } ?>
        </select>
      </div>

      <div class="form-group">
        <label for="paidBySelect">Who Paid?</label>
        <select id="paidBySelect">
          <option value="0">Not Specified</option>
          <? for (var i = 0; i < spouseNames.length; i++) { ?>
          <option value="<?= i + 1 ?>">
            <?= spouseNames[i] ?>
          </option>
          <? } ?>
        </select>
      </div>

      <div class="actions">
        <button type="button" class="btn-primary" id="submit-btn" onclick="submitForm()">Add Expense</button>
        <button type="button" class="btn-secondary" onclick="google.script.host.close()">Cancel</button>
      </div>
    </form>
  </div>

  <script>
    const executionMode = <?= mode ?>;

    // Handle PAP and Paid mutual exclusivity
    const papCheckbox = document.getElementById('papCheckbox');
    const paidCheckbox = document.getElementById('paidCheckbox');

    papCheckbox.addEventListener('change', function () {
      if (this.checked) {
        paidCheckbox.checked = false;
      }
    });

    paidCheckbox.addEventListener('change', function () {
      if (this.checked) {
        papCheckbox.checked = false;
      }
    });

    function submitForm() {
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = 'Adding...';

      var name = document.getElementById('expenseName').value;
      var type = document.getElementById('expenseType').value;
      var amount = document.getElementById('expenseAmount').value;
      var pap = papCheckbox.checked;
      var split = document.getElementById('splitCheckbox').checked;
      var paid = paidCheckbox.checked;
      var period = document.getElementById('expensePeriod').value;

      var paidBySelect = document.getElementById('paidBySelect');
      var paidByIndex = parseInt(paidBySelect.value) || 0;
      var paidByName = paidBySelect.options[paidBySelect.selectedIndex].text;
      if (paidByIndex === 0) paidByName = '';

      clearErrors();

      var errors = [];
      if (!name) {
        errors.push('Expense Name is required');
        document.getElementById('expenseName').classList.add('input-error');
      }
      if (!type) {
        errors.push('Category is required');
        document.getElementById('expenseType').classList.add('input-error');
      }

      if (errors.length > 0) {
        var errorDiv = document.getElementById('errorMessage');
        errorDiv.innerHTML = '<strong>Validation Error:</strong><br>' + errors.join('<br>');
        errorDiv.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Add Expense';
        return;
      }

      google.script.run
        .withSuccessHandler(closeDialog)
        .withFailureHandler(function (err) {
          alert('Error: ' + err);
          btn.disabled = false;
          btn.textContent = 'Add Expense';
        })
        .processForm(name, type, amount, pap, period, executionMode, split, paid, paidByName, paidByIndex);
    }

    function closeDialog() {
      google.script.host.close();
    }

    function clearErrors() {
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('expenseName').classList.remove('input-error');
      document.getElementById('expenseType').classList.remove('input-error');
    }
  </script>
</body>

</html>