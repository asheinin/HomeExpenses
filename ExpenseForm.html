<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <style>
    body {
      padding: 20px;
      font-size: 14px;
      /* Increased slightly */
    }

    .block {
      margin-bottom: 15px;
      /* Increased spacing */
    }

    .actions {
      margin-top: 25px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
      /* Consistent font size */
      padding: 4px;
      /* More padding for larger font */
    }

    #expenseAmount {
      width: 150px;
    }

    label {
      font-size: 14px;
      margin-bottom: 4px;
      display: block;
    }

    .inline-group {
      display: flex;
      gap: 20px;
    }

    .inline-group .block {
      flex: 1;
    }

    .checkbox-row {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .checkbox-inline {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      cursor: pointer;
    }

    .checkbox-inline input[type="checkbox"] {
      margin: 0;
    }

    .error-message {
      color: #d93025;
      font-size: 13px;
      margin-bottom: 10px;
      padding: 8px 12px;
      background-color: #fce8e6;
      border-radius: 4px;
      display: none;
    }

    .input-error {
      border: 2px solid #d93025 !important;
      background-color: #fef7f6;
    }
  </style>

</head>

<body>
  <form id="expenseForm">
    <div id="errorMessage" class="error-message"></div>
    <div class="block form-group">
      <label for="expenseName"><b>Expense Name*</b></label>
      <input type="text" id="expenseName" placeholder="home insurance" required>
    </div>

    <div class="block form-group">
      <label for="expenseType"><b>Expense Type*</b></label>
      <input type="text" id="expenseType" list="typeChoices" placeholder="Utilities" required>
      <datalist id="typeChoices">
        <? for (var i = 0; i < expenseTypes.length; i++) { ?>
        <option value="<?= expenseTypes[i] ?>">
          <? } ?>
      </datalist>
    </div>

    <div class="block form-group">
      <label for="expenseAmount"><b>Amount ($)</b></label>
      <input type="number" step="0.01" id="expenseAmount" placeholder="0.00">
    </div>

    <div class="block checkbox-row">
      <label class="checkbox-inline"><input type="checkbox" id="papCheckbox"> PAP</label>
      <label class="checkbox-inline"><input type="checkbox" id="splitCheckbox" checked> Split</label>
      <label class="checkbox-inline"><input type="checkbox" id="paidCheckbox"> Paid</label>
    </div>


    <div class="block form-group">
      <label for="expensePeriod"><b>Billing Period</b></label>
      <select id="expensePeriod">
        <option value="">-- Select Period --</option>
        <? for (var i = 0; i < expensePeriods.length; i++) { ?>
        <option value="<?= expensePeriods[i] ?>">
          <?= expensePeriods[i] ?>
        </option>
        <? } ?>
      </select>
    </div>

    <div class="block form-group">
      <label for="paidBySelect"><b>Paid By</b></label>
      <select id="paidBySelect">
        <option value="0">-- Select --</option>
        <? for (var i = 0; i < spouseNames.length; i++) { ?>
        <option value="<?= i + 1 ?>">
          <?= spouseNames[i] ?>
        </option>
        <? } ?>
      </select>
    </div>

    <div class="block actions">
      <button type="button" class="blue" id="submit-btn" onclick="submitForm()">Add Expense</button>
      <button type="button" onclick="google.script.host.close()">Cancel</button>
    </div>
  </form>

  <script>
    const executionMode = <?= mode ?>;

    function submitForm() {
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      var name = document.getElementById('expenseName').value;
      var type = document.getElementById('expenseType').value;
      var amount = document.getElementById('expenseAmount').value;
      var pap = document.getElementById('papCheckbox').checked;
      var split = document.getElementById('splitCheckbox').checked;
      var paid = document.getElementById('paidCheckbox').checked;
      var period = document.getElementById('expensePeriod').value;

      var paidBySelect = document.getElementById('paidBySelect');
      var paidByIndex = parseInt(paidBySelect.value) || 0;
      var paidByName = paidBySelect.options[paidBySelect.selectedIndex].text;
      if (paidByIndex === 0) paidByName = '';

      // Clear previous errors
      clearErrors();

      var errors = [];
      if (!name) {
        errors.push('Expense Name is required');
        document.getElementById('expenseName').classList.add('input-error');
      }
      if (!type) {
        errors.push('Expense Type is required');
        document.getElementById('expenseType').classList.add('input-error');
      }

      if (errors.length > 0) {
        var errorDiv = document.getElementById('errorMessage');
        errorDiv.innerHTML = errors.join('<br>');
        errorDiv.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Add Expense';
        return;
      }

      google.script.run
        .withSuccessHandler(closeDialog)
        .withFailureHandler(function (err) {
          alert('Error: ' + err);
          btn.disabled = false;
          btn.textContent = 'Add Expense';
        })
        .processForm(name, type, amount, pap, period, executionMode, split, paid, paidByName, paidByIndex);
    }

    function closeDialog() {
      google.script.host.close();
    }

    function clearErrors() {
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('expenseName').classList.remove('input-error');
      document.getElementById('expenseType').classList.remove('input-error');
    }
  </script>
</body>

</html>